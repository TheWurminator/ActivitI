//Checks to see if the token given by the user is legitimate

function tokenCheck(){
	var graph = require('fbgraph');
	var db = require('../database/DBConnection.js');
	this.con = new db(); //Needs to be closed at some point
}

tokenCheck.prototype.checkToken = function(token, cb){
	var query = "select * from users where uid=" + token;
	var currentRef = this;
	this.con.sendQuery(query, function(response,err){
		console.log(response.length);
		if(response.length < 1 ){
			console.log("User not found");
			cb("Invalid user");
		}
		else{
			console.log("The user was found in the database");
			//Now we need to check the fbtoken
			this.fbCheck(response.fbtoken, cb);
		}
	});
}

//Gets the legitimate fbtoken from the database based on the token entered
//Runs a fb graph api request to see if it's valid or not
tokenCheck.prototype.fbCheck = function(fbtoken, cb){
	//Making the graph call
	this.graph
	  	.setAccessToken(this.getFacebookToken())
	  	.get("/me?" + facebookParameters, function(err, data) {
		if(err){
	  		console.log("Token is invalid");
	  		cb("Invalid Facebook Token");
	  	}
	  	else{
			console.log("Token is valid, continuing on");
			cb("Valid Everything");
	  	}
		});
}

module.exports = tokenCheck;